# adapted from https://github.com/imathis/octopress/blob/master/Rakefile   
# usage rake new_post['My New Post'] or rake new_post (defaults to "My New Post")
desc "Start a new post"
task :new do |t, args|
  params = defaults
  puts "Title?"
  v = $stdin.gets.chomp
  unless v.nil? or v.empty?
    params[:title]=v
  end

  puts "Date? [#{params[:modified]}]"
  v = $stdin.gets.chomp
  unless v.nil? or v.empty?
    params[:modified]=v
  end

  generate params
end

def defaults()
  defaults=Hash.new
  defaults[:id]=Time.now.to_i
  defaults[:title]="New post title"
  defaults[:layout]="post"
  defaults[:type]=""
  defaults[:description]="Some description"
  defaults[:headline]=""
  defaults[:modified]="#{Time.now.strftime('%Y-%m-%d')}"
  defaults[:category]="personal"
  defaults[:tags]=['tag1', 'tag2']
  defaults[:location]=Hash["name" => "north pole"]
  defaults[:imagefeature]=""
  defaults[:comments]="true"
  defaults[:published]="true"
  defaults
end

def generate(args)
  filename = "_posts/#{args[:modified]}-#{args[:title].downcase.gsub(/&/,'and').gsub(/[,'":\?!\(\)\[\]]/,'').gsub(/[\W\.]/, '-').gsub(/-+$/,'')}.md"
  puts "Creating new post: #{filename}"
  if File.file? filename
    fail "The file already exists"
  end
  open(filename, 'w') do |post|
    post.puts "---"
    args.each do |k, v|

      if v.is_a?(Array)
        post.puts "#{k}:"
        v.each do |e|
          post.puts " - #{e}"
        end

      elsif v.is_a?(Hash)
        post.puts "#{k}:"
        v.each do |a, z|
          post.puts " #{a}: #{z}"
        end

      else
        post.puts "#{k}: #{v}"
      end

    end
    post.puts ""
    post.puts "---"
    post.puts ""
    post.puts '<figure class="">'
    post.puts '  <a href="/images/X.jpg"><img src="/images/scale/X.jpg"/></a>'
    post.puts "  <figcaption></figcaption>"
    post.puts "</figure>"
  end
end

